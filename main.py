"""the main file. Controls all componets of this project:
Motor
Display
Internet
Input
Speaker
"""
#imports
from lib.ssd1309 import Display
import framebuf
from machine import SPI, Pin
import config
from config import display
booticon = bytearray([0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x40, 0x60, 0x60, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xc0, 0x40, 0x40, 0x40, 0x40, 0xe0, 0xc0, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x06, 0x06, 0x07, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x07, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x07, 0x07, 0x03, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xb8, 0x8e, 0x83, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x0e, 0x06, 
0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x70, 0x18, 0x04, 0x06, 0x86, 0xfc, 0x00, 0x00, 0x00, 0xc0, 
0x78, 0x0c, 0x06, 0x06, 0x0c, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x70, 
0x18, 0x0c, 0x06, 0x03, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xff, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x7e, 0xff, 0x07, 0x01, 0x00, 0x80, 0xc1, 0x39, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x0f, 
0x38, 0xc0, 0x80, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0xff, 0x00, 0x00, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0xff, 0x40, 0x60, 
0x20, 0x20, 0x00, 0x00, 0x07, 0x0d, 0x18, 0x10, 0x18, 0x3c, 0x03, 0x00, 0x00, 0x00, 0x00, 0x0f, 
0x30, 0x20, 0x30, 0x38, 0x0c, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0x01, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x70, 0xff, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x07, 0x04, 0x06, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x01, 0x03, 0x02, 0x03, 0x01, 0x01, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xf0, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x06, 0x0c, 
0x08, 0x18, 0x10, 0x10, 0x10, 0x10, 0x08, 0x0c, 0x04, 0x03, 0x01, 0x00, 0xff, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0x03, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x0f, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00])
icon = framebuf.FrameBuffer(booticon, 128, 64, framebuf.MONO_VLSB)
display.draw_sprite(icon, x=0 , y=0, w=128, h=64)
display.present()
from machine import RTC #type: ignore
from utime import sleep_ms #type: ignore
import urequests #type: ignore
import errno
from components import Motor, Alarm, Switch, Button
from lib.neotimer import Neotimer
import lib.timeutils as timeutils
from lib.picodfplayer import DFPlayer
from lib.ntptime import settime
from motds import motd_parser
from connect import check_connection
from displaystates import bally, display
from motds import motd_reciever_copy_2
import connect
import displaystates
import json
from config import motor, speaker
from movements import *
#motor setup

custom_movement = [
    ('r', 400, 100),  # quick burst right at full speed
    ('l', 400, 100),  # quick burst left at full speed
    ('r', 300, 100),  # shorter burst right
    ('l', 300, 100),  # shorter burst left
    ('w', 200, 0),    # brief pause
    ('r', 600, 80),   # longer slide right at slightly lower speed
    ('l', 600, 80),   # longer slide left
    ('w', 100, 0),    # quick pause
    ('r', 200, 100),  # quick snap right
    ('l', 200, 100),  # quick snap left
    ('w', 300, 0),    # pause before finish
    ('r', 500, 90),   # final strong move right
    ('l', 500, 90)    # final strong move left
]

alm_cmd = None
def make_set_alm_cmd(val):
    def handler():
        global alm_cmd
        alm_cmd = val
    return handler

home_cmd = None
def make_set_home_cmd(val):
    def handler():
        global home_cmd
        home_cmd = val
    return handler

alm_buttons = [
    Button(config.fwd, make_set_alm_cmd('fwd')),
    Button(config.rev, make_set_alm_cmd('rev')),
    Button(config.alm_set, make_set_alm_cmd('exit')),
    Button(config.snd_fx_l, make_set_alm_cmd('selection'))
]
home_buttons = [
    Button(config.alm_set, make_set_home_cmd('goto_alarm')),
    Button(config.snze_l, make_set_home_cmd('toggle_light')),
    Button(config.fwd, make_set_home_cmd('read_msg')),
    Button(config.snd_fx_l, make_set_home_cmd('toggle_display'))
]
firsttime_alm = True

with open('motds.json', 'r') as f:
    motds_data = json.load(f)

def ringtone_to_movement(alarm, _ringtone_index):
    if _ringtone_index == 13:
        alarm.motor_movement = freedom_dive
    elif _ringtone_index == 8:
        alarm.motor_movement = i_am_speed
    else:
        alarm.motor_movement = custom_movement

with open('alarms.json', 'r') as f:
    alarm = json.load(f)
    alarm = alarm[0]
    alarm_hour = int(alarm['hour'])
    alarm_minute = int(alarm['minute'])
    alarm_ampm = alarm['ampm']
    alarm_ringtone = alarm['ringtone']

mode = 'home'
scroller = 0
usb_power = Pin('WL_GPIO2', Pin.IN)
switch = Switch(config.switch)
display_timer = Neotimer(config.display_timeout_min*60_000) 
display_timer.start()
myalarm = Alarm(10, 39, config.alarm_timeout_min*60, True, custom_movement, alarm_ringtone, motor, speaker, display, display_timer)
ringtone_to_movement(myalarm, alarm_ringtone)
#myalarm = Alarm(alarm_hour, alarm_minute, 120, True, custom_movement, alarm_ringtone, motor, speaker, display)
refresh_time_cooldown_timer = Neotimer(0)
refresh_time_cooldown_timer.start()

motd_done = False
motd = motd_parser.select_random_motd(motds_data)
motd = motd['motd']
motd_len = bally.measure_text(motd)
s, clients = motd_reciever_copy_2.web_setup()
new_motds = []
for motd_json in motds_data:
    if motd_json['new'] is True:
        print('found an new motd')
        print('appending', motd_json)
        new_motds.append(motd_json)
        print('new motds', new_motds)

rtc = RTC()
connect.do_connect()
settime()



try:    
    while True:
        now = rtc.datetime()
        #webserver
        new_motd = motd_reciever_copy_2.web_server(s, clients)
        if new_motd is not None:
            new_motds.append(new_motd)

        #handle alarm
        myalarm.update(now)

        if switch.get_state():
            myalarm.enabled = True
        else:
            myalarm.enabled = False

        if display_timer.finished() and display.on:
            print("display got timed out")
            display.sleep()
            display_timer.restart()
            mode = 'home'
    
        if home_cmd is not None or alm_cmd is not None:
            display_timer.restart()

        #ntp
        hour = now[4]
        minute = now[5]
        if hour == 2+12 and minute == 5 and refresh_time_cooldown_timer.finished():
            print("setting time via ntp...")
            settime()
            refresh_time_cooldown_timer = Neotimer(70_000)
            refresh_time_cooldown_timer.start()

        switch.update()
        if mode == 'home':
            for btn in home_buttons:
                btn.update()

            if home_cmd == 'toggle_light' and myalarm.is_active:
                myalarm.stop()
                home_cmd = None
                continue

            elif home_cmd == 'toggle_light':
                print("toggling light...")
                try:
                    response = urequests.get('http://192.168.1.45/toggle_light')
                except OSError as e:
                    print("sending GET request failed")
                try:
                    response = response.text()
                except OSError as e:
                    if e.errno == errno.ECONNRESET:
                        print("reading response failed")
                except Exception:
                    print("Didn't work. Maybe the server is down?")
                else:
                    response.close()  

            elif home_cmd == 'toggle_display':
                home_cmd = None
                print('toggling display')
                if not display.on:
                    display.wake()
                    display_timer.start()

                else:
                    display_timer.restart()
                    display.sleep()
                    continue
            #Important point. Past here, in home mode, no processing happens when display is off.
            if not display.on:
                continue

            if home_cmd == 'goto_alarm':
                mode = 'set_alarm'

            elif home_cmd == 'read_msg' and len(new_motds) != 0:
                with open('motds.json', 'r') as f:
                    all_motds = json.load(f)

                for motd in all_motds:
                    print(new_motds)
                    if motd['id'] == new_motds[0]['id']:
                        motd['new'] = False
                        break

                motd = new_motds[0]
                new_motds.pop(0)
                motd = f"{motd['motd']} @{motd['author']}"
                motd_len = bally.measure_text(motd)
                scroller = 0
                
                with open('motds.json', 'w') as f:
                    json.dump(all_motds, f)

                with open('motds.json', 'r') as f:
                    motds_data = json.load(f)

            if motd_done:
                print("motd done, selecting random one out of")
                print(motds_data)
                motd = motd_parser.select_random_motd(motds_data)
                motd = motd['motd']
                motd_len = bally.measure_text(motd)

            scroller += 1
            if scroller >= motd_len + display.width + 10:
                motd_done = True
                scroller = 0
            else:
                motd_done = False

            if len(new_motds) != 0:
                display_mail = True
            else:
                display_mail = False

            displaystates.home(usb_power(), switch.get_state(), check_connection(), display_mail, motd, scroller, now)
        
            home_cmd = None

        elif mode == 'set_alarm':
            if firsttime_alm:
                with open('alarms.json', 'r') as f:
                    alarm = json.load(f)
                with open('ringtones.json', 'r') as f:
                    ringtone_json = json.load(f)
                alarm = alarm[0]
                alarm_hour = int(alarm['hour'])
                alarm_minute = int(alarm['minute'])
                alarm_ampm = alarm['ampm']
                ringtone_index = alarm['ringtone']
                select_hm = 'minute'
                firsttime_alm = False

            for btn in alm_buttons:
                btn.update()

            alarm_hour, alarm_minute, alarm_ampm, ringtone_index, select_hm, exit_alm = displaystates.set_alarm(
                alarm_hour, alarm_minute, alarm_ampm, ringtone_index, ringtone_json, select_hm, alm_cmd)

            alm_cmd = None
            if exit_alm:
                mode = 'home'
                firsttime_alm = True
                alarm_hour = timeutils.to_military_time(alarm_hour, alarm_ampm)
                myalarm.hour = alarm_hour
                myalarm.minute = alarm_minute
                myalarm.ringtone = ringtone_index
                ringtone_to_movement(myalarm, ringtone_index)
finally:
    print("doing cleanup")
    speaker.cleanup()
    displaystates.display.cleanup()
    motor.stop()
    print("cleanup success!")
